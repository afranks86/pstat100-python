<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PSTAT100 – lab6-regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">PSTAT100</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Course syllabus</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content.html">Materials</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../miscellany.html">Miscellany</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lab-6-regression" id="toc-lab-6-regression" class="nav-link active" data-scroll-target="#lab-6-regression">Lab 6: Regression</a></li>
  <li><a href="#data-fertility-rates" id="toc-data-fertility-rates" class="nav-link" data-scroll-target="#data-fertility-rates">Data: fertility rates</a></li>
  <li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis">Exploratory analysis</a>
  <ul class="collapse">
  <li><a href="#question-1-education-and-fertility-rate" id="toc-question-1-education-and-fertility-rate" class="nav-link" data-scroll-target="#question-1-education-and-fertility-rate">Question 1: Education and fertility rate</a></li>
  <li><a href="#question-2-hdi-and-fertility-rate" id="toc-question-2-hdi-and-fertility-rate" class="nav-link" data-scroll-target="#question-2-hdi-and-fertility-rate">Question 2: HDI and fertility rate</a></li>
  </ul></li>
  <li><a href="#simple-linear-regression" id="toc-simple-linear-regression" class="nav-link" data-scroll-target="#simple-linear-regression">Simple linear regression</a>
  <ul class="collapse">
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a>
  <ul class="collapse">
  <li><a href="#question-3-center-the-explanatory-variable" id="toc-question-3-center-the-explanatory-variable" class="nav-link" data-scroll-target="#question-3-center-the-explanatory-variable">Question 3: center the explanatory variable</a></li>
  </ul></li>
  <li><a href="#fitted-values-and-residuals" id="toc-fitted-values-and-residuals" class="nav-link" data-scroll-target="#fitted-values-and-residuals">Fitted values and residuals</a>
  <ul class="collapse">
  <li><a href="#question-4-calculations-by-hand" id="toc-question-4-calculations-by-hand" class="nav-link" data-scroll-target="#question-4-calculations-by-hand">Question 4: calculations ‘by hand’</a></li>
  <li><a href="#question-5-prediction-intervals" id="toc-question-5-prediction-intervals" class="nav-link" data-scroll-target="#question-5-prediction-intervals">Question 5: prediction intervals</a></li>
  <li><a href="#question-6-coverage" id="toc-question-6-coverage" class="nav-link" data-scroll-target="#question-6-coverage">Question 6: coverage</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#multiple-linear-regression" id="toc-multiple-linear-regression" class="nav-link" data-scroll-target="#multiple-linear-regression">Multiple linear regression</a>
  <ul class="collapse">
  <li><a href="#question-7-fit-a-model-with-hdi-only" id="toc-question-7-fit-a-model-with-hdi-only" class="nav-link" data-scroll-target="#question-7-fit-a-model-with-hdi-only">Question 7: fit a model with HDI only</a></li>
  </ul></li>
  <li><a href="#submission" id="toc-submission" class="nav-link" data-scroll-target="#submission">Submission</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Otter</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> otter</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>grader <span class="op">=</span> otter.Notebook(<span class="st">"lab6-regression.ipynb"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># disable row limit for plotting</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>alt.data_transformers.disable_max_rows()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment to ensure graphics display with pdf export</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># alt.renderers.enable('mimetype')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="lab-6-regression" class="level1">
<h1>Lab 6: Regression</h1>
<p>This lab covers the nuts and bolts of fitting linear models. The linear model expresses a response variable, <span class="math inline">\(y\)</span>, as a linear function of <span class="math inline">\(p - 1\)</span> explanatory variables <span class="math inline">\(x_1, \dots, x_{p - 1}\)</span> and a random error <span class="math inline">\(\epsilon\)</span>. Its general form is:</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 x_1 + \cdots + \beta_{p - 1} x_{p - 1} + \epsilon \qquad \epsilon \sim N(0, \sigma^2)\]</span></p>
<p>Usually, the response and explanatory variables and error term are indexed by observation <span class="math inline">\(i = 1, \dots, n\)</span> so that the model describes a dataset comprising <span class="math inline">\(n\)</span> values of each variable:</p>
<p><span class="math display">\[y_i = \beta_0 + \beta_1 x_{i1} + \cdots + \beta_{p - 1} x_{i, p - 1} + \epsilon_i \qquad\begin{cases} \epsilon_i \sim N(0, \sigma^2) \\ i = 1, \dots, n\end{cases}\]</span></p>
<p>Because the indices get confusing to keep track of, it is much easier to express the model in matrix form as</p>
<p><span class="math display">\[\mathbf{y} = \mathbf{X}\beta + \epsilon\]</span></p>
<p>where:</p>
<p><span class="math display">\[\mathbf{y} = \left[\begin{array}{c} y_1 \\ y_2 \\ \vdots \\ y_n \end{array}\right]_{\;n \times 1} \qquad
    \mathbf{X} = \left[\begin{array}{cccc}
        1 &amp;x_{11} &amp;\cdots &amp;x_{1, p - 1} \\
        1 &amp;x_{21} &amp;\cdots &amp;x_{2, p - 1} \\
        \vdots &amp;\vdots &amp;\ddots &amp;\vdots \\
        1 &amp;x_{n1} &amp;\cdots &amp;x_{n, p - 1}
        \end{array}\right]_{\;n \times p} \qquad
    \beta = \left[\begin{array}{c} \beta_0 \\ \beta_1 \\ \vdots \\ \beta_{p - 1} \end{array} \right]_{\;p \times 1} \qquad
    \epsilon = \left[\begin{array}{c} \epsilon_1 \\ \epsilon_2 \\ \vdots \\ \epsilon_n \end{array}\right]_{\;n \times 1}\]</span></p>
<p><strong>Fitting</strong> a model of this form means <em><strong>estimating the parameters</strong></em> <span class="math inline">\(\beta_0, \beta_1, \dots, \beta_{p - 1}\)</span> and <span class="math inline">\(\sigma^2\)</span> from a set of data.</p>
<ul>
<li>The ordinary least squares (OLS) estimates of <span class="math inline">\(\beta\)</span>, which are best under most circumstances, are</li>
</ul>
<p><span class="math display">\[\hat{\beta} = (\mathbf{X'X})^{-1}\mathbf{X'y}\]</span></p>
<ul>
<li>The error variance <span class="math inline">\(\sigma^2\)</span> can be estimated by</li>
</ul>
<p><span class="math display">\[\hat{\sigma}^2 = \frac{1}{n - p - 1}\left(\mathbf{y} - \mathbf{X}\hat{\beta}\right)'\left(\mathbf{y} - \mathbf{X}\hat{\beta}\right)\]</span></p>
<p>When fitting a linear model, it is also of interest to quantify uncertainty by estimating the variability of <span class="math inline">\(\hat{\beta}\)</span> and measure overall quality of fit. This lab illustrates that process and the computations involved.</p>
<p><strong>Objectives</strong></p>
<p>In this lab, you’ll learn how to:</p>
<ul>
<li>compute OLS estimates;</li>
<li>calculate fitted values and residuals;</li>
<li>compute the error variance estimate;</li>
<li>compute the variance-covariance matrix of <span class="math inline">\(\hat{\beta}\)</span>, which quantifies the variability of model estimates;</li>
<li>compute standard errors for each model estimate;</li>
<li>compute the proportion of variation captured by a linear model.</li>
</ul>
<p>Throughout you’ll use simple visualizations to help make the connection between fitted models and the aspects of a dataset that model features describe.</p>
</section>
<section id="data-fertility-rates" class="level1">
<h1>Data: fertility rates</h1>
<p>By way of data, you’ll work with country indicators, total fertility rates, and gender indicators for a selection of countries in 2018, and explore the decline in fertility rates associated with developed nations. Data from the U.S. 2020 census indicated significant <a href="https://www.washingtonpost.com/dc-md-va/interactive/2021/2020-census-us-population-results/">population growth decline in the United States</a>. If the topic interests you, you can read more about perspectives and existing data in this <a href="https://ourworldindata.org/fertility-rate">Our World in Data article</a>.</p>
<p>The data are stored in separate <code>.csv</code> files imported below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>fertility <span class="op">=</span> pd.read_csv(<span class="st">'data/fertility.csv'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>country <span class="op">=</span> pd.read_csv(<span class="st">'data/country-indicators.csv'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>gender <span class="op">=</span> pd.read_csv(<span class="st">'data/gender-data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The variables you’ll work with in this portion are the following:</p>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Dataset</th>
<th>Name</th>
<th>Variable</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>fertility</code></td>
<td><code>fertility_total</code></td>
<td>National fertility rate</td>
<td>Average number of children per woman</td>
</tr>
<tr class="even">
<td><code>country</code></td>
<td><code>hdi</code></td>
<td>Human development index</td>
<td>Index between 0 and 1 (0 is lowest, 1 is highest)</td>
</tr>
<tr class="odd">
<td><code>gender</code></td>
<td><code>edu_expected_yrs_f</code></td>
<td>Expected years of education for adult women</td>
<td>Years</td>
</tr>
</tbody>
</table>
<p>Because the variables of interest are stored in three separate dataframes, you’ll first need to extract them and merge by country.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># slice variables of interest</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>fertility_sub <span class="op">=</span> fertility.loc[:, [<span class="st">'Country'</span>, <span class="st">'fertility_total'</span>]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>gender_sub <span class="op">=</span> gender.loc[:, [<span class="st">'educ_expected_yrs_f'</span>, <span class="st">'Country'</span>]]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>country_sub <span class="op">=</span> country.loc[:, [<span class="st">'Country'</span>, <span class="st">'hdi'</span>]]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># merge variables of interest</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>reg_data <span class="op">=</span> pd.merge(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    fertility_sub, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    gender_sub, </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    on <span class="op">=</span> <span class="st">'Country'</span>, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    how <span class="op">=</span> <span class="st">'inner'</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>).merge(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    country_sub,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    on <span class="op">=</span> <span class="st">'Country'</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    how <span class="op">=</span> <span class="st">'left'</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>).set_index(<span class="st">'Country'</span>).dropna()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># preview</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>reg_data.head(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll treat the fertility rates as our variable of interest.</p>
</section>
<section id="exploratory-analysis" class="level1">
<h1>Exploratory analysis</h1>
<p>A preliminary step in regression analysis is typically data exploration through scatterplots. The objective of exploratory analysis in this context is to identify an approximately linear relationship to model.</p>
<!-- BEGIN QUESTION -->
<section id="question-1-education-and-fertility-rate" class="level3">
<h3 class="anchored" data-anchor-id="question-1-education-and-fertility-rate">Question 1: Education and fertility rate</h3>
<p>Construct a scatterplot of total fertility against expected years of education for women. Label the axes ‘Fertility rate’ and ‘Expected years of education for women’. Store this plot as <code>scatter_educ</code> and display the graphic.</p>
<p>(<em>Remark</em>: be sure to include <code>scale = alt.Scale(zero = False)</code> in the axis specification so that your plot does not have extra whitespace.)</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- END QUESTION -->
<p>This figure shows a clear negative association between fertility rate and women’s educational attainment, <em>and</em> that the relationship is roughly linear. Next, check whether HDI seems to be related to fertility rate.</p>
<!-- BEGIN QUESTION -->
</section>
<section id="question-2-hdi-and-fertility-rate" class="level3">
<h3 class="anchored" data-anchor-id="question-2-hdi-and-fertility-rate">Question 2: HDI and fertility rate</h3>
<p>Now construct a scatterplot comparing fertility rate with HDI. Make sure you choose appropriate labels for your axes and plot. Store this plot as <code>scatter_hdi</code> and display the graphic.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- END QUESTION -->
<p>This figure shows a negative relationship between fertility rate and HDI; it may not be exactly linear, but a line should provide a decent approximation. So, the plots suggest that a linear regression model in one or both explanatory variables is reasonable.</p>
</section>
</section>
<section id="simple-linear-regression" class="level1">
<h1>Simple linear regression</h1>
<p>To start you’ll fit a simple linear model regressing fertility on education.</p>
<p>First we’ll need to store the quantities – the response and explanatory variables – needed for model fitting in the proper format. Recall that the linear model in matrix form is:</p>
<p>$$_{}</p>
<pre><code>= \underbrace{\left[\begin{array}{cc}
    1 &amp; x_1 \\ \vdots &amp;\vdots \\ 1 &amp; x_n
    \end{array}\right]}_\mathbf{X}
  \underbrace{\left[\begin{array}{c} \beta_0 \\ \beta_1 \end{array}\right]}_\beta
  + \underbrace{\left[\begin{array}{c} \epsilon_1 \\ \vdots \\ \epsilon_n \end{array}\right]}_\epsilon$$
  </code></pre>
<p>Notice that the explanatory variable matrix <span class="math inline">\(\mathbf{X}\)</span> includes a column of ones for the intercept. So the quantities needed are:</p>
<ul>
<li><span class="math inline">\(\mathbf{y}\)</span>, a one-dimensional array of the total fertility rates for each country; and</li>
<li><span class="math inline">\(\mathbf{X}\)</span>, a two-dimensional array with a column of ones (intercept) and a column of the expected years of education for women (explanatory variable).</li>
</ul>
<p>The cell below constructs these arrays as pandas objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve response</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> reg_data.fertility_total</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># construct explanatory variable matrix</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> sm.tools.add_constant(reg_data.educ_expected_yrs_f)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print first five rows of x</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>x.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="estimation" class="level2">
<h2 class="anchored" data-anchor-id="estimation">Estimation</h2>
<p>‘Fitting’ a model refers to computing estimates; <code>statsmodels.OLS()</code> will fit a linear regression model based on the response vector and explanatory variable matrix. Note that the model structure is implicit – <code>OLS</code> will fit <span class="math inline">\(y = X\beta + \epsilon\)</span> no matter what, so you need to be sure you have arranged <span class="math inline">\(X\)</span> and <span class="math inline">\(y\)</span> correctly to fit the model that you intend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>slr <span class="op">=</span> sm.OLS(endog <span class="op">=</span> y, exog <span class="op">=</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This returns an object of a distinct model class specific to <code>OLS</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(slr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Associated with the class are various attributes and methods. From the model instance, <code>.fit()</code> retrieves the model results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(slr.fit())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, however, that <code>slr.fit()</code> will not produce any interesting output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>slr.fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What the <code>.fit()</code> method does is create a results object that contains parameter estimates and other quantities we might want to retrieve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>rslt <span class="op">=</span> slr.fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coeffient estimates <span class="math inline">\(\hat{\beta}_0, \hat{\beta}_1\)</span> are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rslt.params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The error variance estimate <span class="math inline">\(\hat{\sigma}^2\)</span> is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rslt.scale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It was noted in lecture that the variances and covariances of <span class="math inline">\(\hat{\beta}_0, \hat{\beta}_1\)</span> are given by the matrix:</p>
<p><span class="math display">\[\sigma^2 (\mathbf{X}'\mathbf{X})^{-1}
  = \left[\begin{array}{cc}
        \text{var}\hat{\beta}_0 &amp; \text{cov}\left(\hat{\beta}_0, \hat{\beta}_1\right) \\
        \text{cov}\left(\hat{\beta}_1, \hat{\beta}_0\right) &amp; \text{var}\hat{\beta}_1
        \end{array}\right]\]</span></p>
<p>So we can <em>estimate</em> these quantities, which quantify the variation and covariation of the estimated coefficients, by plugging in the estimated error variance and computing <span class="math inline">\(\hat{\sigma}^2 (\mathbf{X}'\mathbf{X})^{-1}\)</span>. This estimate is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>rslt.cov_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Standard errors for the coefficient estimates are obtained from the diagonal entries. We might create a nice summary of all the estimates as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>coef_tbl <span class="op">=</span> pd.DataFrame({<span class="st">'estimate'</span>: rslt.params.values,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">'standard error'</span>: np.sqrt(rslt.cov_params().values.diagonal())},</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>              index <span class="op">=</span> x.columns)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>coef_tbl.loc[<span class="st">'error variance'</span>, <span class="st">'estimate'</span>] <span class="op">=</span> rslt.scale</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>coef_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, a standard metric often reported with linear models is the <span class="math inline">\(R^2\)</span> score, which is interpreted as the proportion of variation in the response captured by the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute R-squared</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>rslt.rsquared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, the expected years of education for women in a country explains 72% of variability in fertility rates, and furthermore, according to the fitted model:</p>
<ul>
<li>for a country in which women are entirely uneducated, the estimated mean fertility rate is 7.5 children on average by the end of a woman’s reproductive period</li>
<li>each additional year of education for women is associated with a decrease in a country’s fertility rate of an estimated 0.43</li>
<li>after accounting for women’s education levels, fertility rates vary by a standard deviation of <span class="math inline">\(0.66 = \sqrt{0.438}\)</span> across countries</li>
</ul>
<section id="question-3-center-the-explanatory-variable" class="level3">
<h3 class="anchored" data-anchor-id="question-3-center-the-explanatory-variable">Question 3: center the explanatory variable</h3>
<p>Note that <em>no</em> countries report an expected zero years of education for women, so the meaning of the intercept is artificial. As we saw in lecture, centering the explanatory variable can improve interpretability of the intercept. Center the expected years of education for women and refit the model by following the steps outlined below. Display the coefficient estimates and standard errors.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># center the education column by subtracting its mean from each value</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>educ_ctr <span class="op">=</span> ...</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># reconstruct the explanatory variable matrix</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>x_ctr <span class="op">=</span> ...</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># fit new model</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>slr_ctr <span class="op">=</span> ...</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>rslt_ctr <span class="op">=</span> ...</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># arrange estimates and se's in a dataframe and display</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>grader.check(<span class="st">"q3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="fitted-values-and-residuals" class="level2">
<h2 class="anchored" data-anchor-id="fitted-values-and-residuals">Fitted values and residuals</h2>
<p>The <strong>fitted value</strong> for <span class="math inline">\(y_i\)</span> is the value along the line specified by the model that corresponds to the matching explanatory variable <span class="math inline">\(x_i\)</span>. In other words:</p>
<p><span class="math display">\[\hat{y}_i = \hat{\beta}_0 + \hat{\beta}_1 x_i\]</span></p>
<p>These can be obtained directly from <code>rslt</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted values</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>rslt.fittedvalues</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is an array with length matching the number of rows in <code>x</code>; note the index for the pandas series – the fitted values are returned in the same order as the observations used to fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(rslt.fittedvalues.index <span class="op">==</span> x.index).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that model <strong>residuals</strong> are the difference between observed and fitted values:</p>
<p><span class="math display">\[e_i = y_i - \hat{y}_i\]</span></p>
<p>These are similarly retrievable as an attribute of the regression results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>rslt.resid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note again that these are returned in the same order as the original observations.</p>
<section id="question-4-calculations-by-hand" class="level3">
<h3 class="anchored" data-anchor-id="question-4-calculations-by-hand">Question 4: calculations ‘by hand’</h3>
<p>Calculate the fitted values and residuals manually. Store the results as arrays <code>fitted_manual</code> and <code>resid_manual</code>, respectively.</p>
<p><em>Hint</em>: use matrix-vector multiplication.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fitted_manual <span class="op">=</span> ...</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>resid_manual <span class="op">=</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>grader.check(<span class="st">"q4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is often convenient to add the fitted values and residuals as new columns in <code>reg_data</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># append fitted values and residuals</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'fitted_slr'</span>] <span class="op">=</span> rslt.fittedvalues</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'resid_slr'</span>] <span class="op">=</span> rslt.resid</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>reg_data.head(<span class="dv">3</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use this augmented dataframe to visualize the deterministic part of the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct line plot</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>slr_line <span class="op">=</span> alt.Chart(reg_data).mark_line().encode(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="st">'educ_expected_yrs_f'</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="st">'fitted_slr'</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># layer</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>scatter_educ <span class="op">+</span> slr_line</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To obtain uncertainty bands about the estimated mean, we’ll compute predictions at each observed value using <code>.get_prediction()</code> – this method by default returns standard errors associated with each prediction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> rslt.get_prediction(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predictions are stored as <code>.predicted_mean</code>. Since we computed predictions at the observed values, the predictions should match the fitted values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(preds.predicted_mean <span class="op">==</span> rslt.fittedvalues).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Standard errors are stored as <code>.se_mean</code>. Uncertainty bands are typically drawn <span class="math inline">\(2SE\)</span> in either direction from the fitted values; so we’ll append those values to the original data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'lwr_mean'</span>] <span class="op">=</span> preds.predicted_mean <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>preds.se_mean</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'upr_mean'</span>] <span class="op">=</span> preds.predicted_mean <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>preds.se_mean</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>reg_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use these to shade in the area between the lower and upper limits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>band <span class="op">=</span> alt.Chart(reg_data).mark_area(opacity <span class="op">=</span> <span class="fl">0.2</span>).encode(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="st">'educ_expected_yrs_f'</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="st">'lwr_mean'</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    y2 <span class="op">=</span> <span class="st">'upr_mean'</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># layer</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>scatter_educ <span class="op">+</span> slr_line <span class="op">+</span> band</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As discussed in lecture, we can also compute and display uncertainty bounds for predicted observations (rather than the mean). These will be wider, because there is more uncertainty associated with predicting observations compared with estimating the mean.</p>
</section>
<section id="question-5-prediction-intervals" class="level3">
<h3 class="anchored" data-anchor-id="question-5-prediction-intervals">Question 5: prediction intervals</h3>
<p>The standard error for <em>predictions</em> is stored with the output of <code>.get_prediction()</code> as the attribute <code>.se_obs</code> – standard error for observations. Use this and follow the example above to compute 95% uncertainty bounds for the observations. Add the lower and upper bounds as new columns of <code>reg_data</code> named <code>lwr_obs</code> and <code>upr_obs</code>, respectively. Construct a plot showing data scatter, the model predictions, and prediction uncertainty bands.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute prediction uncertainty bounds</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'lwr_obs'</span>] <span class="op">=</span> ...</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">'upr_obs'</span>] <span class="op">=</span> ...</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># construct plot showing prediction uncertainty</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>grader.check(<span class="st">"q5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that the interpretation of the prediction band is that 95% of the time, the band will cover the observed values.</p>
</section>
<section id="question-6-coverage" class="level3">
<h3 class="anchored" data-anchor-id="question-6-coverage">Question 6: coverage</h3>
<p>What proportion of observed values are within the prediction bands? Compute and store this value as <code>coverage_prop</code>.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>coverage_prop <span class="op">=</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>grader.check(<span class="st">"q6"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="multiple-linear-regression" class="level1">
<h1>Multiple linear regression</h1>
<p>Now let’s consider adding the human development factor to the model. First let’s investigate the <em>univariate</em> relationship between HDI and fertility rate.</p>
<p>A scatterplot is shown below with a regression line overlaid. The relationship perhaps isn’t perfectly linear, but a line should provide a decent approximation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> alt.Chart(reg_data).mark_circle().encode(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> alt.X(<span class="st">'hdi'</span>, title <span class="op">=</span> <span class="st">'Human development index'</span>, scale <span class="op">=</span> alt.Scale(zero <span class="op">=</span> <span class="va">False</span>)),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> alt.Y(<span class="st">'fertility_total'</span>, title <span class="op">=</span> <span class="st">'Fertility rate'</span>, scale <span class="op">=</span> alt.Scale(zero <span class="op">=</span> <span class="va">False</span>))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>base <span class="op">+</span> base.transform_regression(on <span class="op">=</span> <span class="st">'fertility_total'</span>, regression <span class="op">=</span> <span class="st">'hdi'</span>).mark_line()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- BEGIN QUESTION -->
<section id="question-7-fit-a-model-with-hdi-only" class="level3">
<h3 class="anchored" data-anchor-id="question-7-fit-a-model-with-hdi-only">Question 7: fit a model with HDI only</h3>
<p>Fit the model plotted above. Display the coefficient estimates, standard errors, and <span class="math inline">\(R^2\)</span> statistic.</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> ...</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>slr <span class="op">=</span> ...</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>rslt <span class="op">=</span> ...</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># construct coefficient table</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>coef_tbl <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> ...</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>coef_tbl.loc[<span class="st">'error variance'</span>, <span class="st">'estimate'</span>] <span class="op">=</span> ...</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># display table and print r squared</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- END QUESTION -->
<p>You should have observed that this model <em>also</em> explains about 70% of variance in fertility rates. So it seems like an equally good predictor of fertility rates. However, HDI is highly correlated with women’s education:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>reg_data.corr().loc[<span class="st">'hdi'</span>, <span class="st">'educ_expected_yrs_f'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So what do you think will happen if we fit a model with both explanatory variables? Will fertility rate have a stronger association with one or the other? Will the coefficient estimates also be highly correlated? Take a moment to consider this and come up with a hypothesis.</p>
<p>The model is fit <em>exactly</em> the same way as the SLR models – all we need change is the explanatory variable matrix. Instead of grabbing one column from the data, we now grab two:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct explanatory variable matrix</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> sm.tools.add_constant(reg_data.loc[:, [<span class="st">'hdi'</span>, <span class="st">'educ_expected_yrs_f'</span>]])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>mlr <span class="op">=</span> sm.OLS(endog <span class="op">=</span> y, exog <span class="op">=</span> x)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># store results</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>rslt <span class="op">=</span> mlr.fit() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient table is shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>coef_tbl <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'estimate'</span>: rslt.params.values,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'standard error'</span>: np.sqrt(rslt.cov_params().values.diagonal()) </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> x.columns </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>coef_tbl.loc[<span class="st">'error variance'</span>, <span class="st">'estimate'</span>] <span class="op">=</span> rslt.scale</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>coef_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The association with HDI is not as strong as in the simple linear model – note the coefficient estimate here is about -4.1, compared with about -7.0 if education is not included.</p>
<p>Similarly, the association with education is not as strong as in the simple linear model with only education – if HDI is not included in the model, the coefficient estimate is about -0.43, whereas with both variables the estimate is about -0.20.</p>
<p>So both associations are weaker when both terms are included in the model. Further, the estimates are strongly correlated:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>vcov <span class="op">=</span> rslt.cov_params()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>stderr <span class="op">=</span> np.sqrt(vcov.values.diagonal())</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>corr_mx <span class="op">=</span> np.diag(<span class="dv">1</span><span class="op">/</span>stderr).dot(vcov).dot(np.diag(<span class="dv">1</span><span class="op">/</span>stderr))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'correlation of hdi and educ coefficient estimates: '</span>, corr_mx[<span class="dv">1</span>, <span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The multiple linear regression model captures a little bit more variance than either simple linear regression model individually:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rslt.rsquared</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The MLR model doesn’t add much value in terms of fit, so if that is our only concern we might prefer one of the SLR models. However, the presence of additional predictors changes the parameter interpretation – in the MLR model, the coefficients give the estimated changes in mean fertility rate associated with changes in each explanatory variable <em>after accounting for the other explanatory variable</em>. This is one way of understanding why the estimates change so much in the presence of additional explanatory variables – the association between, <em>e.g.</em>, HDI and fertility, is different than the association between HDI and fertility after adjusting for women’s expected education.</p>
<p>More broadly, these data are definitely <em>not</em> a representative sample of any particular population of nations – the countries (observational units) are conveniently chosen based on which countries reported data. So there is no scope of inference here, for any of the models we’ve fit.</p>
<p>Although we can’t claim that, for example, ‘the mean fertility rate decreases with education at a rate of 0.2 children per woman per expected year of education after accounting for development status’, we <em>can</em> say ‘<em>among the countries reporting data</em>, the mean fertility rate decreases with education at a rate of 0.2 children per woman per expected year of education after accounting for development status’. This is a nice example of how a model might be used in a descriptive capacity.</p>
</section>
</section>
<section id="submission" class="level1">
<h1>Submission</h1>
<ol type="1">
<li>Save the notebook.</li>
<li>Restart the kernel and run all cells. (<strong>CAUTION</strong>: if your notebook is not saved, you will lose your work.)</li>
<li>Carefully look through your notebook and verify that all computations execute correctly and all graphics are displayed clearly. You should see <strong>no errors</strong>; if there are any errors, make sure to correct them before you submit the notebook.</li>
<li>Download the notebook as an <code>.ipynb</code> file. This is your backup copy.</li>
<li>Export the notebook as PDF and upload to Gradescope.</li>
</ol>
<hr>
<p>To double-check your work, the cell below will rerun all of the autograder tests.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>grader.check_all()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>